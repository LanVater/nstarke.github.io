<!DOCTYPE html>
<html>
<head>
<title>0033-linksys-ea4500-device-firmware-decryption.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="linksys-ea4500-v30-firmware-decryption">Linksys EA4500 v3.0 Firmware Decryption</h1>
<p>Published: March 24, 2020</p>
<p>The first thing I wanted to do was to update the firmware for the device.
<a href="https://www.linksys.com/us/support-article?articleNum=148385">https://www.linksys.com/us/support-article?articleNum=148385</a> offers the latest version of the firmware, which is <code>3.1.7</code> as of this writing.</p>
<p>However, we can see with the filename that its probably encrypted: <code>FW_EA4500V3_3.1.7.181919_prod.gpg.img</code></p>
<p>When I run binwalk I don't get any meaningful results, confirming my suspcicions:</p>
<pre class="hljs"><code><div>$ binwalk FW_EA4500V3_3.1.7.181919_prod.gpg.img

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
3168198       0x3057C6        Cisco IOS experimental microcode, <span class="hljs-keyword">for</span> <span class="hljs-string">"k"</span>
</div></code></pre>
<p><strong>Note that the Cisco IOS experimental microcode result is almost always a false positive, even though this is a Cisco branded device.</strong></p>
<p>So we need to find the key. We know that it is a GPG key. The Linksys product support page says this:</p>
<blockquote>
<p>However, if you prefer to do manual updates and your router is on version 3.1.6.166173 or older, YOU MUST download &amp; update your router using firmware version 3.1.6 (Build 172023) first before loading the latest firmware</p>
</blockquote>
<p>This leads me to believe the firmware was once not encrypted and then a subsequent version was encrypted.  That means the gpg key is probably somewhere in an earlier firmware version.  So next we download the version <code>3.1.6</code>.  The filename is thus: <code>FW_EA4500V3_3.1.6.172023_prod.img</code></p>
<p>Note that there is no <code>gpg</code> substring in the file name.  This leads me to believe that this firmware version is not encrypted.  We run binwalk to confirm:</p>
<pre class="hljs"><code><div>$ binwalk FW_EA4500V3_3.1.6.172023_prod.img

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             uImage header, header size: 64 bytes, header CRC: 0x522CD43A, created: 2016-04-21 20:36:47, image size: 1536238 bytes, Data Address: 0x80060000, Entry Point: 0x80060000, data CRC: 0xF4B0BD80, OS: Linux, CPU: MIPS, image <span class="hljs-built_in">type</span>: OS Kernel Image, compression <span class="hljs-built_in">type</span>: lzma, image name: <span class="hljs-string">"Linksys Impala Router"</span>
64            0x40            LZMA compressed data, properties: 0x6D, dictionary size: 8388608 bytes, uncompressed size: 4555944 bytes
3145728       0x300000        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 14179096 bytes, 3201 inodes, blocksize: 262144 bytes, created: 2016-04-21 21:30:41
</div></code></pre>
<p>Score! So we can use binwalk's Matryoshka extraction mode to extract the squashs filesystem:</p>
<pre class="hljs"><code><div>$ binwalk -eM FW_EA4500V3_3.1.6.172023_prod.img
</div></code></pre>
<p>Now that we have the filesystem extracted for version <code>3.1.6</code>, we need to go looking for something that looks like a public key.</p>
<p>I did a <code>find</code> for <code>*.asc*</code>, <code>*.pem</code>, and <code>*.gpg</code> to no avail, so I decided to just <code>grep</code> for what I was looking for:</p>
<pre class="hljs"><code><div>$ grep -r <span class="hljs-string">'PUBLIC KEY'</span> .
./etc/certs/server.pem:-----BEGIN PUBLIC KEY-----
./etc/certs/server.pem:-----END PUBLIC KEY-----
./etc/keydata:-----BEGIN PGP PUBLIC KEY BLOCK-----
./etc/keydata:-----END PGP PUBLIC KEY BLOCK-----
Binary file ./lib/libcrypto.so.0.9.8 matches
Binary file ./usr/bin/gpg matches
</div></code></pre>
<p>From experience I can guess that <code>./etc/certs/server.pem</code> is most likely the web management interface's TLS cert for HTTPS communications.  But <code>./etc/keydata</code> looking interesting:</p>
<pre class="hljs"><code><div>$ file ./etc/keydata 
./etc/keydata: PGP public key block Public-Key (old)
</div></code></pre>
<p>So let's try it out and see if it can decrypt the <code>3.1.7</code> firmware version:</p>
<pre class="hljs"><code><div>$ gpg --import ./etc/keydata
$ gpg --decrypt FW_EA4500V3_3.1.7.181919_prod.gpg.img &gt; FW_EA4500V3_3.1.7.181919_prod.img
</div></code></pre>
<p>And it works! Now we have a plaintext version of the firmware:</p>
<pre class="hljs"><code><div>$ file FW_EA4500V3_3.1.7.181919_prod.img
FW_EA4500V3_3.1.7.181919_prod.img: u-boot legacy uImage, Linksys Impala Router, Linux/MIPS, OS Kernel Image (lzma), 1536489 bytes, Fri Jun 16 00:41:05 2017, Load Address: 0x80060000, Entry Point: 0x80060000, Header CRC: 0x9DACD513, Data CRC: 0xA097E0E3
$ binwalk FW_EA4500V3_3.1.7.181919_prod.img

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             uImage header, header size: 64 bytes, header CRC: 0x9DACD513, created: 2017-06-16 00:41:05, image size: 1536489 bytes, Data Address: 0x80060000, Entry Point: 0x80060000, data CRC: 0xA097E0E3, OS: Linux, CPU: MIPS, image <span class="hljs-built_in">type</span>: OS Kernel Image, compression <span class="hljs-built_in">type</span>: lzma, image name: <span class="hljs-string">"Linksys Impala Router"</span>
64            0x40            LZMA compressed data, properties: 0x6D, dictionary size: 8388608 bytes, uncompressed size: 4556000 bytes
3145728       0x300000        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 15154172 bytes, 3294 inodes, blocksize: 262144 bytes, created: 2017-06-16 01:34:18
</div></code></pre>
<p>Now I can start the reverse engineering process.</p>
<p>It's also worth noting that although we can decrypt the firmware for reverse engineering, we cannot encrypt our own firmware to upload to the device.  That integrity checking is mostly what the firmware decryption is in place for - to prevent malicious actors from uploading a modified firmware version.  Because the private key is kept private, it is not possible to encrypt custom firmware. Also, my bet is that the <code>3.1.7</code> firmware has checks in place to prevent unencrypted firmware from being flashed onto the device, meaning it is probably not possible to downgrade from <code>3.1.7</code>.</p>
<p><strong>Update:</strong> Here is <code>/etc/keydata</code>:</p>
<pre class="hljs"><code><div>-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1

mQENBFZM/2EBCADOq3bG1vDkWZkMFynSoCSsz0iD5DtD7igVJ/GizWn/oD/fNGld
WX3D6VInykkcWPQf+CAmvxzGNEJGISBOd7x2Hcr3c1Yf/HMdTWwSzjRbfxj1lThf
DBv9JPBmZ8YYywK3N3dBh4s+m33pOqZxvoOAcR1cCJSECt8L0AV+BwI+1XnhUERy
nYt1BKCkh5MRhuYLFCqIcjFQxScfHEiCZFnuo7XPjSv4kFqdt8W+dxH4hh+ieFFw
m4lfeVKHR8GG+K1lFhAjVAiIKp49iY0tlgGqkARo5nIRyIW0KVOyZ+ikc0/M97LN
XIpf9u16jUb0xigjBt2njMm2bxc/3vsm92JrABEBAAG0KWxpbmtzeXMgPGxpbmtz
eXMtdG9vbC1zdXBwb3J0QGJlbGtpbi5jb20+iQE4BBMBAgAiBQJWTP9hAhsvBgsJ
CAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRB5cFSk6+K7j6pyCAC2DUoKbXyb5ZZs
bFTVdctM9DhYGEegXG68yQoHSk9GAeCXkpHHG6iRy2Jf1AJVFttKGx243Y6ewoGe
UUYyCg/v0p3ZxuWUjJpjeULNQZDXhD+xHIIYLBjb92bXHLIWcR+QTuKVHHWJSjtu
kD0yMPtcYKcxfO+r5OZTi0agQdvQZLVicQg09bkMdXg4+9QrOnMkjN85kD1zQSPt
Lov+M245NHtOJ80IZ5PI7bhMS/NY1uShWhBYfIMYlBmyYOse8uJaMMh3P3tBvE5O
qYNh9564Iq1f2Rpg3fmAJriwPrBMsEenOWLS8dt8EiLDM5DxKDoo6l6NwYNZ6sWM
O0q6JsIP
=svmk
-----END PGP PUBLIC KEY BLOCK-----
</div></code></pre>
<p><a href="https://nstarke.github.io/">Back</a></p>

</body>
</html>
