<!DOCTYPE html>
<html>
<head>
<title>0035-linksys-ea4500-v1.0-writeup.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="linksys-ea4500-v10-write-up">Linksys EA4500 v1.0 Write Up</h1>
<p><strong>tl;dr: I was not able to identify any command injection vulnerabilities that might let me take control of the router.</strong></p>
<h2 id="firmware">Firmware</h2>
<p>The firmware is available <a href="https://downloads.linksys.com/downloads/firmware/FW_EA4500_2.1.42.183584_prod.img">here</a>.  The support page for this product is <a href="https://www.linksys.com/us/support-article?articleNum=148385">here</a>.  The latest firmware build for hardware version 1.0 is <code>2.1.42</code> which was released <code>9/19/2017</code>.  According to <a href="https://www.linksys.com/us/support-article?articleNum=291976">here</a> this device was EOL'd in May 2014.</p>
<p>The dynamic portions of the web interface are handled by the <code>/usr/sbin/jnap</code> binary. There is exactly one instance of the <code>system</code> function in the entire binary:</p>
<p><img src="images/0035-system.png" alt="&quot;System Function&quot;" title="System Function"></p>
<p>This function is invoked whenever the LAN is restarted or when the device is rebooted, amongst others. The code looks something like this:</p>
<pre class="hljs"><code><div>    <span class="hljs-keyword">while</span> ((iVar1 = system(
      <span class="hljs-string">"netstat -nlap | egrep \"$REMOTE_ADDR:$REMOTE_PORT.*(ESTABLISHED|FIN_)\"&gt; /dev/null"</span>
      ), iVar1 == <span class="hljs-number">0</span> &amp;&amp; (tVar3 = time((<span class="hljs-keyword">time_t</span> *)<span class="hljs-number">0x0</span>), tVar3 &lt; tVar2 + <span class="hljs-number">3</span>))) {
        sleep(<span class="hljs-number">1</span>);
    }
</div></code></pre>
<p>Unfortunately CGI does not take the <code>$REMOTE_ADDR</code> environment variable from the HTTP <code>Host</code> header, otherwise we might be able to exploit this!</p>
<p>Since this binary is not going to get us where we need to be, I decide to check out the web root on the firmware filesystem.  The webroot is at <code>/www</code>, but all the interesting things are at <code>/www/ui/cgi/</code>:</p>
<pre class="hljs"><code><div>$ ls -l /www/ui/cgi/
bootloader_info.cgi*  get_counter_info.cgi*  getstinfo.cgi*  jcgi.cgi*  localize.cgi*  qos_info.cgi*  speedtest_info.cgi*  sysinfo.cgi*  usbinfo.cgi*
</div></code></pre>
<p>Then I run:</p>
<pre class="hljs"><code><div>$ file /www/ui/cgi/*
www/ui/cgi/bootloader_info.cgi:  POSIX shell script, ASCII text executable
www/ui/cgi/get_counter_info.cgi: ASCII text
www/ui/cgi/getstinfo.cgi:        POSIX shell script, ASCII text executable
www/ui/cgi/jcgi.cgi:             a /usr/bin/lua script, ASCII text executable
www/ui/cgi/localize.cgi:         a /usr/bin/lua script, ASCII text executable
www/ui/cgi/qos_info.cgi:         POSIX shell script, ASCII text executable
www/ui/cgi/speedtest_info.cgi:   POSIX shell script, ASCII text executable
www/ui/cgi/sysinfo.cgi:          POSIX shell script, ASCII text executable
www/ui/cgi/usbinfo.cgi:          POSIX shell script, ASCII text executable
</div></code></pre>
<p>It looks like we have some CGI shell scripts and some CGI Lua scripts.  Let's take a look at the shell scripts first.</p>
<h2 id="cgi-shell-scripts">CGI Shell Scripts</h2>
<p>What we are really interested in here is the HTTP POST body and the <code>$QUERY_STRING</code> environment variable.  The HTTP POST body in CGI will come in as the first argument to the CGI shell script, so we are looking for <code>$1</code> in that case.  Let's do some grepping:</p>
<pre class="hljs"><code><div>$ grep -rn <span class="hljs-string">'$1'</span> /www/ui/cgi
www/ui/cgi/sysinfo.cgi:16:  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> == <span class="hljs-string">""</span> ] ; <span class="hljs-keyword">then</span>
www/ui/cgi/sysinfo.cgi:20:  form_var=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
www/ui/cgi/usbinfo.cgi:5:<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> = <span class="hljs-string">""</span> ]; <span class="hljs-keyword">then</span>
</div></code></pre>
<p>Let's look at <code>www/ui/cgi/sysinfo.cgi</code> first.  The interesting portion of this file is near the top:</p>
<pre class="hljs"><code><div> <span class="hljs-function"><span class="hljs-title">get_cgi_val</span></span> () {
   <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> == <span class="hljs-string">""</span> ] ; <span class="hljs-keyword">then</span>
     <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
     <span class="hljs-built_in">return</span>
   <span class="hljs-keyword">fi</span>
   form_var=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
   var_value=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$QUERY_STRING</span>"</span> | sed -n <span class="hljs-string">"s/^.*<span class="hljs-variable">$form_var</span>=\([^&amp;]*\).*$/\1/p"</span> | sed <span class="hljs-string">"s/%20/ /g"</span> | sed <span class="hljs-string">"s/+/ /g"</span> | sed <span class="hljs-string">"s/%2F/\//g"</span>`
   <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span>
 }
</div></code></pre>
<p>This shell function uses the <code>$QUERY_STRING</code> and <code>$1</code> POST body parameters. Unfortunately there is no string concatenation happening, so we are not able to inject shell meta-characters into the command.</p>
<p>Next's let's move on to <code>www/ui/cgi/usbinfo.cgi</code>.  The interesting portion of the code is here:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> = <span class="hljs-string">""</span> ]; <span class="hljs-keyword">then</span> 
   <span class="hljs-built_in">echo</span> Content-Type: text/plain
   <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
 <span class="hljs-keyword">fi</span>
</div></code></pre>
<p>This is a non-starter because the <code>$1</code> HTTP POST parameter is not passed to any sub-command invocation or otherwised used.</p>
<h2 id="cgi-lua-scripts">CGI Lua Scripts</h2>
<p>There are also two lua scripts in the <code>/www/ui/cgi</code> directory:</p>
<pre class="hljs"><code><div>www/ui/cgi/jcgi.cgi:             a /usr/bin/lua script, ASCII text executable
www/ui/cgi/localize.cgi:         a /usr/bin/lua script, ASCII text executable
</div></code></pre>
<p>Let's once again do some grepping.  This time we will want to look for the system command invocation in lua, which is <code>os.execute</code>:</p>
<pre class="hljs"><code><div>$ grep -rn <span class="hljs-string">'os.execute'</span> www/ui/cgi
www/ui/cgi/jcgi.cgi:99:                verify(os.execute(cmd) == 0, <span class="hljs-string">'ErrorCreatingArchiveFile'</span>)
www/ui/cgi/jcgi.cgi:153:                verify(os.execute(cmd) == 0, <span class="hljs-string">'ErrorExtractArchiveFailed'</span>)
</div></code></pre>
<p>Let's look at <code>jcgi.cgi</code> in more detail.  There seems to be two different operating system command invocations in this CGI Lua script. The first one looks like this:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">local</span> cmd = <span class="hljs-string">'tar -zcf '</span> .. tmpFilePath
<span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, #backupPaths <span class="hljs-keyword">do</span>
    cmd = cmd .. <span class="hljs-string">' '</span> .. backupPaths[i]
<span class="hljs-keyword">end</span>
cmd = cmd .. <span class="hljs-string">' &gt; /dev/null 2&gt;&amp;1'</span>
<span class="hljs-comment">-- Print the command and create a fake archive file if we're debugging</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">'JCGI_DEBUG'</span>) <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">print</span>(cmd)
    <span class="hljs-keyword">local</span> archiveFile = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">open</span>(tmpFilePath, <span class="hljs-string">'w'</span>)
    archiveFile:<span class="hljs-built_in">write</span>(<span class="hljs-string">'A fake tar.gz file'</span>)
    archiveFile:<span class="hljs-built_in">close</span>()
<span class="hljs-keyword">else</span>
     verify(<span class="hljs-built_in">os</span>.<span class="hljs-built_in">execute</span>(cmd) == <span class="hljs-number">0</span>, <span class="hljs-string">'ErrorCreatingArchiveFile'</span>)
<span class="hljs-keyword">end</span>
</div></code></pre>
<p>This function does use string concatenation to build its command string payload, namely using the <code>tmpFilePath</code> variable.  However, the value for this variable is defined on line 23:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">local</span> tmpFilePath = <span class="hljs-built_in">os</span>.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">'JCGI_DEBUG'</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">'jcgi.tmp'</span> <span class="hljs-keyword">or</span> <span class="hljs-string">'/tmp/var/config/jcgi.tmp'</span>
</div></code></pre>
<p>Even if we could inject the <code>JCGI_DEBUG</code> environment variable into the process, defining it would cause program execution to skip the <code>os.execute</code> function invocation.</p>
<p>Moving on to the second occurance of <code>os.execute</code> on line 153:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">local</span> archiveFile = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">open</span>(tmpFilePath, <span class="hljs-string">'w'</span>)
verify(archiveFile, <span class="hljs-string">'ErrorWritingArchiveFile'</span>)
verify(archiveFile:<span class="hljs-built_in">write</span>(archiveBuffer), <span class="hljs-string">'ErrorWritingArchiveFile'</span>)
archiveFile:<span class="hljs-built_in">close</span>()

<span class="hljs-comment">-- Now delete the old IPA cache, extract the achive, and lock out the</span>
<span class="hljs-comment">-- IPA database until the device reboots so that we don't end up with</span>
<span class="hljs-comment">-- duplicate entries</span>
<span class="hljs-keyword">local</span> cmd = <span class="hljs-string">'rm -rf '</span> .. ipaCachePath .. <span class="hljs-string">' &amp;&amp; cd / &amp;&amp; tar -xzf '</span> .. tmpFilePath .. <span class="hljs-string">' tmp/syscfg.tmp var/config/ipa &amp;&amp; touch /tmp/ipa/.lockedout &gt; /dev/null 2&gt;&amp;1'</span>

<span class="hljs-comment">-- Just print the command if we're debugging</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">'JCGI_DEBUG'</span>) <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">print</span>(cmd)
<span class="hljs-keyword">else</span>
    verify(<span class="hljs-built_in">os</span>.<span class="hljs-built_in">execute</span>(cmd) == <span class="hljs-number">0</span>, <span class="hljs-string">'ErrorExtractArchiveFailed'</span>)

</div></code></pre>
<p>So in this case there are three variables which could be used to inject commands into: <code>tmpFilePath</code> , <code>ipaCachePath</code>.  We already know from the first example that <code>tmpFilePath</code> is a no go, but let's take a look at <code>ipaCachePath</code>:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">local</span> ipaCachePath  = <span class="hljs-string">'/var/config/ipa'</span>
</div></code></pre>
<p>Unforunately this value is hard coded on line 21 to the value <code>/var/config/ipa</code> so there is no injection opportunity with this variable.</p>
<p>The last potential injection point is in the variable <code>backupPaths</code>, which is defined on line 21:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">local</span> backupPaths = {ipaCachePath, tmpSyscfgPath}
</div></code></pre>
<p>We know <code>ipaCachePath</code> is a no-go but we need to look now at <code>tmpSyscfgPath</code>. It is defined on line 22:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">local</span> tmpSyscfgPath = <span class="hljs-string">'/tmp/syscfg.tmp'</span>
</div></code></pre>
<p>Another hard coded value.  At this point we know that this instance of <code>os.execute</code> is not vulnerable to command injection.</p>
<p>At this point we have exhausted the contents of <code>/www/ui/cgi</code>.</p>
<p>There are additional lua files in <code>/JNAP/modules/</code>. However, they are all in Lua bytecode format.  I attempted to decompile them back to Lua and had less than optimal results.</p>
<h2 id="analysis">Analysis</h2>
<p>The usage of a scripting language (lua) to handle most of the dynamic web interface resulted in device firmware that was far more difficult to exploit than some of the other older models of Linksys routers.  the <code>/usr/sbin/jnap</code> binary offloads input processing to lua by loading shared objects than then load the lua bytecode in <code>/JNAP/modules</code>.</p>
<p><img src="images/0035-imports.png" alt="&quot;Imports&quot;" title="Imports"></p>
<p>Combined with the lack of a telnet daemon, command injection is not the best approach to penetrating this device.  Looking for memory corruption bugs in the <code>jnap</code> binary would most likely be more fruitful, but then you have the problem of trying to write an exploit for a device that you don't have 1) a shell on and 2) a compiler toolchain for.  It's not impossible, just very diffficult.</p>

<a href="https://nstarke.github.io/">Back</a>
</body>
</html>
